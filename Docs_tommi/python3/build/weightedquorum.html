

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.8. Weighted Quorum &mdash; galera 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="galera 1.0.1 documentation" href="index.html" />
    <link rel="up" title="1. Galera Technical Description" href="technicaldescription.html" />
    <link rel="next" title="1.9. Schema Upgrades" href="schemaupgrades.html" />
    <link rel="prev" title="1.7. Isolation Levels" href="isolationlevels.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="schemaupgrades.html" title="1.9. Schema Upgrades"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="isolationlevels.html" title="1.7. Isolation Levels"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" accesskey="U">1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="weighted-quorum">
<h1>1.8. Weighted Quorum<a class="headerlink" href="#weighted-quorum" title="Permalink to this headline">¶</a></h1>
<span class="target" id="id1"></span><p id="index-0">The current number of nodes in the cluster defines the current
cluster size. There is no configuration setting that would define
the list of all possible cluster nodes. As a result, every time
a node joins the cluster, the total size of the cluster is increased
and when a node leaves the cluster (gracefully) the size is
decreased.</p>
<p>The cluster size determines the required votes to achieve quorum.
A quorum vote is carried out when a node does not respond
and is suspected to no longer be part of the cluster. This no
response timeout is defined by the <tt class="docutils literal"><span class="pre">evs.suspect_timeout</span></tt> setting
in the wsrep_provider_options (default 5 sec).</p>
<p>If a node is determined to be disconnected, the remaining nodes
cast a quorum vote. If a majority from the total nodes connected
from before the disconnect remains, that partition remains up.
In the case of a network partition, there will be nodes active
on both sides of the network disconnect. In this case, only
the quorum will continue, the partition(s) without quorum will
enter the non-Primary state.</p>
<p>As quorum requires a majority, you cannot have automatic failover
in a two-node cluster. The failure of one node will cause the
remaining node to go non-Primary. Furthermore, a cluster with an
even number of nodes has a risk of a split brain condition; if
network connectivity is lost between the two partitions, neither
partition would retain quorum, and both would go to Non-Primary.</p>
<p>For automatic failover, use at least three nodes. The same applies
on other infrastructure levels. For example:</p>
<ul class="simple">
<li>A cluster on a single switch should have 3 nodes</li>
<li>A cluster spanning switches should be spread across at least 3 switches</li>
<li>A cluster spanning networks should be spread across at least 3 networks</li>
<li>A cluster spanning data centers should spread across at least 3 data centers</li>
</ul>
<div class="section" id="galera-arbitrator">
<h2>1.8.1. Galera Arbitrator<a class="headerlink" href="#galera-arbitrator" title="Permalink to this headline">¶</a></h2>
<p>If the expense of adding, for example, a third datacenter is too high,
you can use the Galera arbitrator. An arbitrator is a member of the
cluster which participates in voting, but not it actual replication.</p>
<p>The Galera arbitrator servers two purposes:</p>
<ul class="simple">
<li>It helps to avoid split-brain situations by acting as an odd
node in a cluster that is spread only across two nodes.</li>
<li>It can request a consistent application state snapshot.</li>
</ul>
<p>Galera arbitrator it is a separate daemon called <em>garbd</em>. As a Galera
cluster member, the arbitrator accepts all Galera parameters except those
prefixed as <tt class="docutils literal"><span class="pre">replicator.</span></tt>.</p>
<p>The Galera arbitrator is depicted in the figure below:</p>
<div class="figure">
<img alt="_images/arbitrator.png" src="_images/arbitrator.png" />
<p class="caption"><em>Galera Arbitrator</em></p>
</div>
<p>In the figure above, if one of the data centers fails or loses
WAN connection, the node that sees the arbitrator (and therefore
sees clients) will continue operation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><em>garbd</em> must see all replication traffic although it does not
store it anywhere. Placing the arbitrator in a location with
poor connectivity to the rest of the cluster may lead to poor
cluster performance.</p>
</div>
<p>Arbitrator failure does not affect cluster operation and a new
instance can be reattached to the cluster at any time. There can be
several arbitrators in the cluster.</p>
</div>
<div class="section" id="quorum-calculation">
<h2>1.8.2. Quorum Calculation<a class="headerlink" href="#quorum-calculation" title="Permalink to this headline">¶</a></h2>
<p>Galera supports a weighted quorum, where each node can be
assigned a weight in the 0 to 255 range, with which it will
participate in quorum calculations.</p>
<p>The quorum calculation formula is:</p>
<div class="highlight-python"><pre>(sum(p_i x w_i) - sum(l_i x w_i))/2 &lt; sum(m_i x w_i)</pre>
</div>
<p>Where:</p>
<ul class="simple">
<li><em>p_i</em>—Members of the last seen primary component</li>
<li><em>l_i</em>—Members that are known to have left gracefully</li>
<li><em>m_i</em>—Current component members</li>
<li><em>w_i</em>—Member weights</li>
</ul>
<p>In other words, the quorum is preserved if (and only if) the sum
weight of the nodes in a new component strictly exceeds half of
that of the preceding primary component, minus the nodes which left
gracefully.</p>
<p>Node weight can be customized by using the <tt class="docutils literal"><span class="pre">pc.weight</span></tt> Galera
parameter. By default, the node weight is 1, which translates into
the traditional &#8220;node count&#8221; behavior.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The node weight can be changed in runtime simply by setting
the <tt class="docutils literal"><span class="pre">pc.weight</span></tt> parameter. The new weight is applied when
a message carrying a weight is delivered. At the moment,
there is no mechanism to notify on application of the new
weight, but it will just &#8220;eventually&#8221; happen, when the
message is delivered.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If a group partitions at the moment when the weight change
message is delivered, all partitioned components that deliver
weight change messages in the transitional view will become
non-primary components. Partitions that deliver messages
in the regular view will go through the quorum computation
with the applied weight when the following transitional view
is delivered. In other words, there is a corner case where
the entire cluster can end up in a non-primary component, if
the weight changing message is sent at the moment when the
partitioning takes place.</p>
<p class="last">Recovery from such a situation should be done by either
waiting for a re-merge or by inspecting which partition
is most advanced and by bootstrapping it as a new primary
component.</p>
</div>
</div>
<div class="section" id="weighted-quorum-examples">
<h2>1.8.3. Weighted Quorum Examples<a class="headerlink" href="#weighted-quorum-examples" title="Permalink to this headline">¶</a></h2>
<p id="id2">See below for some weighted quorum examples and use cases:</p>
<ul>
<li><p class="first">Weighted quorum for three nodes:</p>
<div class="highlight-python"><pre>n1: weight 2
n2: weight 1
n3: weight 0</pre>
</div>
<p>Killing nodes n2 and n3 simultaneously preserves primary component
on n1. Killing n1 makes n2 and n3 become non-primary components.</p>
</li>
<li><p class="first">Weighted quorum for a simple master-slave scenario:</p>
<div class="highlight-python"><pre>n1: weight 1
n2: weight 0</pre>
</div>
<p>If master n1 dies, n2 will end up become a non-primary component.
However, if n2 dies, n1 will continue as the primary component.
If the network connection between n1 and n2 fails, n1 will continue
as the primary component and n2 will become a non-primary component.</p>
</li>
<li><p class="first">Weighted quorum for a master and multiple slaves scenario:</p>
<div class="highlight-python"><pre>n1: weight 1
n2: weight 0
n3: weight 0
...
nn: weight 0</pre>
</div>
<p>If n1 dies, all remaining nodes end up as non-primary components.
If any other node dies, the primary component is preserved. In the
case of network partitioning, n1 will always remain as a primary
component.</p>
</li>
<li><p class="first">Weighted quorum for a primary and secondary site scenario:</p>
<div class="highlight-python"><pre>n1: weight 2
n2: weight 2
n3: weight 1
n4: weight 1</pre>
</div>
<p>Site 1 has nodes n1 and n2, site 2 has nodes n3 and n4. Setting node
weights as above guarantees that nodes at site 1 remain the primary
component if site 2 goes down or if the network between the sites
fails. Also, either n1 or n2 can crash without the rest of the nodes
becoming non-primary components.</p>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1.8. Weighted Quorum</a><ul>
<li><a class="reference internal" href="#galera-arbitrator">1.8.1. Galera Arbitrator</a></li>
<li><a class="reference internal" href="#quorum-calculation">1.8.2. Quorum Calculation</a></li>
<li><a class="reference internal" href="#weighted-quorum-examples">1.8.3. Weighted Quorum Examples</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="isolationlevels.html"
                        title="previous chapter">1.7. Isolation Levels</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="schemaupgrades.html"
                        title="next chapter">1.9. Schema Upgrades</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/weightedquorum.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="schemaupgrades.html" title="1.9. Schema Upgrades"
             >next</a> |</li>
        <li class="right" >
          <a href="isolationlevels.html" title="1.7. Isolation Levels"
             >previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" >1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Tommi Takkunen-Lauri.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>