

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.5. State Snapshot Transfer &mdash; galera 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="galera 1.0.1 documentation" href="index.html" />
    <link rel="up" title="1. Galera Technical Description" href="technicaldescription.html" />
    <link rel="next" title="1.6. Node States" href="nodestates.html" />
    <link rel="prev" title="1.4. Certification Based Replication" href="certificationbasedreplication.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nodestates.html" title="1.6. Node States"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="certificationbasedreplication.html" title="1.4. Certification Based Replication"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" accesskey="U">1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <style> .red {color:red} </style><style> .green {color:green} </style><div class="section" id="state-snapshot-transfer">
<h1>1.5. State Snapshot Transfer<a class="headerlink" href="#state-snapshot-transfer" title="Permalink to this headline">¶</a></h1>
<p id="id1">State Snapshot Transfer (SST) refers to a full data copy from
one cluster node (donor) to the joining node (joiner).
SST is used when a new node joins the cluster. To get synchronized
with the cluster, the new node has to transfer data from a node
that is already part of the cluster. In Galera Replication, you
can choose from two conceptually different ways to transfer a
state from one MySQL server to another:</p>
<ul>
<li><p class="first"><em>mysqldump</em>—<em>mysqldump</em> requires the receiving server to be
fully initialized and ready to accept connections
<em>before</em> the transfer.</p>
<p><em>mysqldump</em> is a blocking method as the donor node
becomes <tt class="docutils literal"><span class="pre">READ-ONLY</span></tt> while data is being copied
from one node to another (SST applies the <tt class="docutils literal"><span class="pre">FLUSH</span>
<span class="pre">TABLES</span> <span class="pre">WITH</span> <span class="pre">READ</span> <span class="pre">LOCK</span></tt> command for the donor).</p>
<p><em>mysqldump</em> is also the slowest SST method and, in a
loaded cluster, this can be an issue.</p>
</li>
<li><p class="first"><em>rsync</em> / <em>rsync_wan</em>—<em>rsync</em> / <em>rsync_wan</em>
copies data files directly. This requires that the
receiving server is initialized <em>after</em> the transfer.
Methods such as <em>rsync</em>, <em>rsync_wan</em>, <em>xtrabackup</em>
and other methods fall into this category.</p>
<p>These methods are faster than <em>mysqldump</em>, but they have
certain limitations. They can only be used on server startup,
the receiving server must be configured very similarly to
the donor (for example, the <tt class="docutils literal"><span class="pre">innodb_file_per_table</span></tt>
value must be the same, and so on).</p>
<p>Some of these methods, for example <em>xtrabackup</em>, can be
made non-blocking on donor. These methods are supported
through a scriptable SST interface.</p>
</li>
</ul>
<p>For more information, see chapter
<a class="reference internal" href="#id4">Comparison of State Snapshot Transfer Methods</a>.</p>
<p>You can configure the state snapshot transfer method
with the <tt class="docutils literal"><span class="pre">wsrep_sst_method</span></tt> variable. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wsrep_sst_method</span><span class="o">=</span><span class="n">rsync_wan</span>
</pre></div>
</div>
<div class="section" id="incremental-state-transfer-ist">
<h2>1.5.1. Incremental State Transfer (IST)<a class="headerlink" href="#incremental-state-transfer-ist" title="Permalink to this headline">¶</a></h2>
<p id="id2">Galera supports a functionality known as incremental state
transfer. Incremental state transfer means that if:</p>
<ol class="arabic simple">
<li>the joining node state UUID is the same as that of the group, and</li>
<li>all of the missed writesets can be found in the donor Gcache</li>
</ol>
<p>then, instead of whole state snapshot, a node will receive the
missing writes ets and catch up with the group by replaying them.</p>
<p>For example, if the local node state is:</p>
<div class="highlight-python"><pre>5a76ef62-30ec-11e1-0800-dba504cf2aab:197222</pre>
</div>
<p>...and the group state is:</p>
<div class="highlight-python"><pre>5a76ef62-30ec-11e1-0800-dba504cf2aab:201913</pre>
</div>
<p>...and if writeset number <em>197223</em> is still in the donor&#8217;s
writeset cache (GCache), it will send write sets <em>197223</em>-<em>201913</em>
to the joiner instead of the whole state.</p>
<p>IST can dramatically speed up the remerging of a node
to the cluster. It is also non-blocking on the donor.</p>
<p>Perhaps the most important parameter for IST is the GCache size
on the donor. The bigger it is, the more write sets can be
stored in it and the bigger seqno gaps can be closed with
IST. On the other hand, if the GCache is much bigger than
the state size, serving IST may be less efficient than
sending a state snapshot.</p>
<div class="section" id="writeset-cache-gcache">
<h3>1.5.1.1. Writeset Cache (GCache)<a class="headerlink" href="#writeset-cache-gcache" title="Permalink to this headline">¶</a></h3>
<p id="id3">Galera stores write sets in a special cache called Writeset
Cache (GCache). In short, GCache is a memory allocator for
write sets and its primary purpose is to minimize the write
set footprint on the <abbr title="Random-access memory">RAM</abbr>.
Galera also improves the offload writeset storage to disk</p>
<p>GCache has three types of stores:</p>
<ol class="arabic">
<li><p class="first">A permanent in-memory store, where write sets are allocated
by the default OS memory allocator. This store can be useful
in systems that have spare RAM. The store has a hard size
limit. By default, it is disabled (the size is set to 0).</p>
</li>
<li><p class="first">A permanent ring-buffer file, which is preallocated on disk
during cache initialization. This store is intended as the
main writeset store. By default, its size is 128Mb.</p>
</li>
<li><p class="first">An on-demand page store, which allocates memory-mapped page
files during runtime as necessary. The default page size is
128Mb, but it can also be bigger if it needs to store a bigger
writeset.</p>
<p>The size of the page store is limited by the free disk space.
By default, page files are deleted when not in use, but a
limit can be set on the total size of the page files to
keep. When all other stores are disabled, at least one
page file is always present on disk.</p>
</li>
</ol>
<p>The allocation algorithm attempts to store write sets in the above
order. If the first store does not have enough space to allocate the
writeset, the allocation algorithm attempts to store it on the next
store. The page store always succeeds, unless the writeset is bigger
than the available disk space.</p>
<p>By default, GCache allocates files in the working directory of
the process, but a dedicated location can be specified (see chapter
<a class="reference internal" href="galeraparameters.html#id1"><em>Galera Parameters</em></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since all cache files are memory-mapped, the process may
appear to use more memory than it actually does.</p>
</div>
</div>
</div>
<div class="section" id="comparison-of-state-snapshot-transfer-methods">
<h2>1.5.2. Comparison of State Snapshot Transfer Methods<a class="headerlink" href="#comparison-of-state-snapshot-transfer-methods" title="Permalink to this headline">¶</a></h2>
<p id="id4">There is no single best state snapshot transfer method; the method
must be chosen depending on the situation. Fortunately, the choice
only must be done on the receiving node; the donor will serve
whatever is requested, as long as it has support for it.</p>
<p>See the table below for a summary table on the the difference
between the different state snapshot transfer methods:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="12%" />
<col width="15%" />
<col width="19%" />
<col width="14%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Speed</th>
<th class="head">Blocks the donor?</th>
<th class="head">Available on live node?</th>
<th class="head">Logical/Physical</th>
<th class="head">Requires root access to MySQL server?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>mysqldump</td>
<td><span class="red">slow</span></td>
<td><span class="red">yes</span></td>
<td>yes</td>
<td>logical</td>
<td>both donor and joiner</td>
</tr>
<tr class="row-odd"><td>rsync</td>
<td>fastest</td>
<td><span class="red">yes</span></td>
<td><span class="red">no</span></td>
<td>physical</td>
<td>none</td>
</tr>
<tr class="row-even"><td>xtrabackup</td>
<td>fast</td>
<td>For a short time</td>
<td><span class="red">no</span></td>
<td>physical</td>
<td>donor only</td>
</tr>
</tbody>
</table>
<p>When comparing the different state snapshot transfer methods,
the division between a logical state snapshot and a physical
state snapshot is important, especially from the perspective
of configuration:</p>
<ul>
<li><p class="first"><strong>Physical state snapshot</strong></p>
<p><span class="green">Pluses</span>: Physical state snapshot is the fastest to transfer,
as by definition it does not involve a server on either end. It
just physically copies data from the disk at one node to the disk
on the other. It does not depend on the joining node database being
in a working condition: it just writes all over it. This is a good
way to restore a corrupted data directory.</p>
<p><span class="red">Minuses</span>: Physical state snapshot requires the receptor node
to have the same data directory layout and the same storage engine
configuration as the donor. For example, InnoDB should have the same
file-per-table, compression, log file size and similar settings.
Furthermore, a server with initialized storage engines cannor receive
physical state snapshots. This means that:</p>
<ul class="simple">
<li>The node in need of a SST must restart the server.</li>
<li>The server is inaccessible to the mysql client until
the SST is complete, since the server cannot perform
authentication without storage engines.</li>
</ul>
</li>
<li><p class="first"><strong>Logical state snapshot</strong></p>
<p><span class="green">Pluses</span>: A running server can receive a logical state transfer
(in fact, only a fully initialized server can receive a logical state
transfer). Logical state transfer does not require a receptor node
to have the same configuration as the donor node, allowing to upgrade
storage engine options. You can, for example, migrate from the Antelope
to the Barracuda file format, start using compression or resize, or
place iblog* files to another partition.</p>
<p><span class="red">Minuses</span>: A logical state transfer is as slow as mysqldump. The
receiving server must be prepared to accept root connections from
potential donor nodes and the receiving server must have a
non-corrupted database.</p>
</li>
</ul>
<div class="section" id="mysqldump">
<h3>1.5.2.1. mysqldump<a class="headerlink" href="#mysqldump" title="Permalink to this headline">¶</a></h3>
<p><em>Mysqldump</em> requires the receiving node to have a fully functional
database (which can be empty) and the same root credentials as the
donor has. It also requires root access from other nodes. <em>Mysqldump</em>
is several times slower than other methods on sizable databases, but
may be faster if the database is very small (smaller than the log
files, for example). It is also sensitive to the <em>mysqldump</em> tool
version; it must be the most recent. It is not uncommon for several
<em>mysqldump</em> binaries to be found in the system. <em>Mysqldump</em> can fail
if an older <em>mysqldump</em> tool version is incompatible with the newer
server.</p>
<p>The main advantage of <em>mysqldump</em> is that a state snapshot can be
transferred to a working server. That is, the server can be started
standalone and then be instructed to join a cluster from the MySQL
client command line. It also can be used to migrate from older
database formats to newer.</p>
<p>Sometimes <em>mysqldump</em> is the only option. For example, when upgrading
from a MySQL 5.1 cluster with a built-in InnoDB to MySQL 5.5 with an
InnoDB plugin.</p>
<p>The <em>mysqldump</em> script only runs on the sending side and pipes the
<em>mysqldump</em> output to the MySQL client connected to the receiving
server.</p>
</div>
<div class="section" id="rsync">
<h3>1.5.2.2. rsync<a class="headerlink" href="#rsync" title="Permalink to this headline">¶</a></h3>
<p><em>Rsync</em>-based state snapshot transfer is the fastest. It has all pluses and
minuses of the physical snapshot transfer and, in addition, it blocks
the donor for the whole duration of transfer. However, on terabyte-scale
databases, it was found to be considerably (1.5-2 times) faster than
<em>xtrabackup</em>. This is several hours faster. <em>Rsync</em> does not depend on
MySQL configuration or root access. This makes it probably the easiest
method to configure.</p>
<p><em>Rsync</em> also has the <em>rsync-wan</em> modification that engages the <em>rsync</em>
delta transfer algorithm. However, this method is more IO intensive
and should only be used when the network throughput is the bottleneck,
that is usually the case in conjunction with wide area networks.</p>
<p>The <em>rsync</em> script runs on both sending and receiving sides. On the
receiving side, it starts the <em>rsync</em> in server mode and waits for a
connection from the sender. On the sender side, it starts the <em>rsync</em>
in client mode and sends the contents of the MySQL data directory to
the joining node.</p>
<p>The most frequently encountered issue with this method is having
incompatible <em>rsync</em> versions on the donor and on the receiving
server.</p>
</div>
<div class="section" id="xtrabackup">
<h3>1.5.2.3. xtrabackup<a class="headerlink" href="#xtrabackup" title="Permalink to this headline">¶</a></h3>
<p><em>Xtrabackup</em>-based state snapshot transfer is probably the most
popular choice. As <em>rsync</em>, it has the pluses and minuses of the
physical snapshot. However, <em>xtrabackup</em> is a virtually non-blocking
method on the donor. It only blocks the donor for a very short period
of time to copy MyISAM tables, such as system tables. If these tables
are small, the blocking time is very short. This naturally happens at
the cost of speed: <em>xtrabackup</em> can be considerably slower than <em>rsync</em>.</p>
<p>As <em>xtrabackup</em> must copy a large amount of data in the shortest
possible time, it may noticeably degrade the donor performance.</p>
<p>The most frequently encountered problem with <em>xtrabackup</em> is its
configuration. <em>xtrabackup</em> requires that certain options be set
in the <em>my.cnf</em> file (for example <tt class="docutils literal"><span class="pre">datadir</span></tt>) and a local root
access to the donor server. Refer to the <em>xtrabackup</em> manual for
more details.</p>
<p id="scriptable-state-snapshot-transfer">Galera has an interface to customize state snapshot transfer through
an external script. The script assumes that the storage engine
initialization on the receiving node takes place only after the state
transfer is complete. In short, this transfer copies the contents of
the source data directory to the destination data directory (with possible
variations).</p>
<p>As of wsrep API patch level 23.7, SST parameters are named. Individual
scripts can use the <em>wsrep_sst_common.sh</em> file, which contains common
functions for parsing argument lists, logging errors, and so on. There
is no constraint on the order or number of parameters. New parameters
can be added and any parameter can be ignored by the script.</p>
</div>
<div class="section" id="common-parameters">
<h3>1.5.2.4. Common Parameters<a class="headerlink" href="#common-parameters" title="Permalink to this headline">¶</a></h3>
<p>These parameters are always passed to any state transfer script:</p>
<p>? <tt class="docutils literal"><span class="pre">role</span></tt>
? <tt class="docutils literal"><span class="pre">address</span></tt>
? <tt class="docutils literal"><span class="pre">auth</span></tt>
? <tt class="docutils literal"><span class="pre">datadir</span></tt>
? <tt class="docutils literal"><span class="pre">defaults-file</span></tt>
? <tt class="docutils literal"><span class="pre">parent</span></tt></p>
</div>
<div class="section" id="donor-specific-parameters">
<h3>1.5.2.5. Donor-specific Parameters<a class="headerlink" href="#donor-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>These parameters are passed to the state transfer script by the state transfer process:</p>
<dl class="docutils">
<dt>? <tt class="docutils literal"><span class="pre">socket</span></tt>—The local server (donor) socket for</dt>
<dd>communications, if is required.</dd>
</dl>
<p>? <tt class="docutils literal"><span class="pre">gtid</span></tt>—The global transaction ID in format: <tt class="docutils literal"><span class="pre">&lt;uuid&gt;:&lt;seqno&gt;</span></tt>.
? <tt class="docutils literal"><span class="pre">bypass</span></tt>—This parameter specifies whether the actual data</p>
<blockquote>
<div>transfer should be skipped and only the GTID should be passed to
the receiving server (to go straight to incremental state transfer).</div></blockquote>
</div>
<div class="section" id="mysqldump-specific-parameters">
<h3>1.5.2.6. mysqldump-specific Parameters<a class="headerlink" href="#mysqldump-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>These parameters are only passed to the <tt class="docutils literal"><span class="pre">wsrep_sst_mysqldump</span></tt>:</p>
<dl class="docutils">
<dt>? <tt class="docutils literal"><span class="pre">user</span></tt>—The MySQL user to connect to both remote and local</dt>
<dd>servers. The user must be the same on both servers.</dd>
</dl>
<p>? <tt class="docutils literal"><span class="pre">password</span></tt>—MySQL user password.
? <tt class="docutils literal"><span class="pre">host</span></tt>—The remote server (receiver) host address.
? <tt class="docutils literal"><span class="pre">port</span></tt>—The remote server (receiver) port.
? <tt class="docutils literal"><span class="pre">local-port</span></tt>—The local server (donor) port.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1.5. State Snapshot Transfer</a><ul>
<li><a class="reference internal" href="#incremental-state-transfer-ist">1.5.1. Incremental State Transfer (IST)</a><ul>
<li><a class="reference internal" href="#writeset-cache-gcache">1.5.1.1. Writeset Cache (GCache)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#comparison-of-state-snapshot-transfer-methods">1.5.2. Comparison of State Snapshot Transfer Methods</a><ul>
<li><a class="reference internal" href="#mysqldump">1.5.2.1. mysqldump</a></li>
<li><a class="reference internal" href="#rsync">1.5.2.2. rsync</a></li>
<li><a class="reference internal" href="#xtrabackup">1.5.2.3. xtrabackup</a></li>
<li><a class="reference internal" href="#common-parameters">1.5.2.4. Common Parameters</a></li>
<li><a class="reference internal" href="#donor-specific-parameters">1.5.2.5. Donor-specific Parameters</a></li>
<li><a class="reference internal" href="#mysqldump-specific-parameters">1.5.2.6. mysqldump-specific Parameters</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="certificationbasedreplication.html"
                        title="previous chapter">1.4. Certification Based Replication</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nodestates.html"
                        title="next chapter">1.6. Node States</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/statetransfer.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nodestates.html" title="1.6. Node States"
             >next</a> |</li>
        <li class="right" >
          <a href="certificationbasedreplication.html" title="1.4. Certification Based Replication"
             >previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" >1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Tommi Takkunen-Lauri.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>