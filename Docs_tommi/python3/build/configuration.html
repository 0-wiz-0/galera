

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2.5. Configuring Galera Cluster &mdash; galera 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="galera 1.0.1 documentation" href="index.html" />
    <link rel="up" title="2. Getting Started" href="gettingstarted.html" />
    <link rel="next" title="2.6. Creating a Cluster" href="createcluster.html" />
    <link rel="prev" title="2.4. Downloading and Installing Percona XtraDB Cluster" href="installationxtradb.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="createcluster.html" title="2.6. Creating a Cluster"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installationxtradb.html" title="2.4. Downloading and Installing Percona XtraDB Cluster"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="gettingstarted.html" accesskey="U">2. Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="configuring-galera-cluster">
<h1>2.5. Configuring Galera Cluster<a class="headerlink" href="#configuring-galera-cluster" title="Permalink to this headline">¶</a></h1>
<p id="id1">This chapter presents the mandatory and recommended settings
for a Galera cluster. It may be possible to start the cluster after
only setting the <tt class="docutils literal"><span class="pre">wsrep_provider</span></tt> and <tt class="docutils literal"><span class="pre">wsrep_cluster_address</span></tt>
variables. However, the best results can be achieved by
fine-tuning the configuration to best match the use case.</p>
<p>For more information on the settings, see chapter
<a class="reference internal" href="galeraparameters.html#id1"><em>Galera Parameters</em></a>.</p>
<div class="section" id="example-configuration-file">
<h2>2.5.1. Example Configuration File<a class="headerlink" href="#example-configuration-file" title="Permalink to this headline">¶</a></h2>
<p id="id2">See below for an example <em>my.cnf</em> file:</p>
<div class="highlight-python"><pre>[mysqld]
# 1. Mandatory settings: these settings are REQUIRED for proper cluster operation
query_cache_size=0
binlog_format=ROW
default_storage_engine=innodb
innodb_autoinc_lock_mode=2
# innodb_doublewrite=1 - this is the default and it should stay this way

# 2. Optional mysqld settings: your regular InnoDB tuning and such
datadir=/mnt/mysql/data
innodb_buffer_pool_size=28G
innodb_log_file_size=100M
innodb_file_per_table
innodb_flush_log_at_trx_commit=2

# 3. wsrep provider configuration: basic wsrep options
wsrep_provider=/usr/lib64/galera/libgalera_smm.so
wsrep_provider_options="gcache.size=32G; gcache.page_size=1G"
wsrep_cluster_address=gcomm://192.168.0.1,192.168.0.2,192.168.0.3
wsrep_cluster_name='my_galera_cluster'
wsrep_node_address='192.168.0.2'
wsrep_node_name='node2'
wsrep_sst_method=xtrabackup
wsrep_sst_auth=root:rootpa$$

# 4. additional "frequently used" wsrep settings
wsrep_node_incoming_address='192.168.10.2'
wsrep_sst_donor='node3'
wsrep_slave_threads=16</pre>
</div>
<p>In the example above, there are 11 <em>wsrep</em> configuration variables.
This is usually all that is needed for clustering.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Always customize the settings in section 3
before taking the cluster into production.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="mandatory-settings">
<h2>2.5.2. Mandatory Settings<a class="headerlink" href="#mandatory-settings" title="Permalink to this headline">¶</a></h2>
<p id="id3">You must give values to the settings below:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">query_cache_size=0</span></tt>—This value disables the query cache.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">binlog_format=ROW</span></tt>—This variable sets the binary logging format.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">default_storage_engine=InnoDB</span></tt>—InnoDB is a high-reliability
and high-performance storage engine for MySQL. Starting with MySQL
5.5, it is the default MySQL storage engine.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">innodb_autoinc_lock_mode=2</span></tt>—This variable sets the lock mode
to use for generating auto-increment values. Value 2 sets the interleaved
lock mode. See also chapter <a class="reference internal" href="#id8">Setting Parallel CPU Threads</a></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use Galera provider version 2.0 or higher,
set <tt class="docutils literal"><span class="pre">innodb_doublewrite</span></tt> to 1 (default).</p>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="optional-mysql-settings">
<h2>2.5.3. Optional MySQL Settings<a class="headerlink" href="#optional-mysql-settings" title="Permalink to this headline">¶</a></h2>
<p id="id4">For better performance, you can give values to the settings below:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">datadir=/mnt/mysql/data</span></tt>—The MySQL data directory.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">innodb_buffer_pool_size=28G</span></tt>—The size in bytes of the buffer
pool, that is, the memory area where InnoDB caches table and index
data.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">innodb_log_file_size=100M</span></tt>—The size in bytes of each log file
in a log group.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">innodb_file_per_table</span></tt>—When innodb_file_per_table is enabled,
InnoDB stores the data and indexes for each newly created table in
a separate .ibd file, rather than in the system tablespace.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">innodb_flush_log_at_trx_commit</span></tt>—This parameter
improves performance. The parameter defines how often the
log buffer is written out to the log file and how often
the log file is flushed onto disk. When the value is 2,
the log buffer is written out to the file at each commit,
but the flush to disk operation is not performed
on it, but it takes place once per second.</p>
<p>Compared with the default value 1, you can achieve better
performance by setting the value to 2, but an operating system
crash or a power outage can erase the last second of transactions.
However, this risk is handled by synchronous replication—you
can always recover the node from another node.</p>
<p>Set:</p>
<div class="highlight-python"><pre>``innodb_flush_log_at_trx_commit=2``</pre>
</div>
</li>
</ul>
</div>
<div class="section" id="wsrep-provider-settings">
<h2>2.5.4. wsrep Provider Settings<a class="headerlink" href="#wsrep-provider-settings" title="Permalink to this headline">¶</a></h2>
<p id="id5">The basic wsrep provider settings are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</span></tt>—The
path to the Galera plugin.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_cluster_address=gcomm://192.168.0.1,192.168.0.2,192.168.0.3</span></tt>—The
cluster connection URL. See chapter <a class="reference internal" href="createcluster.html#id1"><em>Creating a Cluster</em></a>.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_provider_options=&quot;gcache.size=32G;</span> <span class="pre">gcache.page_size=1G&quot;</span></tt>—A
string of provider options passed directly to provider.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_cluster_name='my_galera_cluster'</span></tt>—The logical cluster
name. If a node tries to connect to a cluster with a different name,
connection fails</li>
<li><tt class="docutils literal"><span class="pre">wsrep_node_address='192.168.0.2'</span></tt>—An option to explicitly
specify the network address of the node if autoguessing for some
reason does not produce desirable results.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_node_name='node2'</span></tt>—The logical node name for convenience.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_sst_method=xtrabackup</span></tt>—The method used for state snapshot transfers.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_sst_auth=root:rootpa$$</span></tt>—A string with authentication
information for state snapshot transfer.</li>
</ul>
<p>For better performance, you can also give values to the settings below:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">wsrep_node_incoming_address='192.168.10.2'</span></tt>—The address at
which the server expects client connections. This parameter is intended
for integration with load balancers.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_sst_donor='node3'</span></tt>—The name of the server that should
be used as a source for state transfer. Give the name as <tt class="docutils literal"><span class="pre">wsrep_node_name</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">wsrep_slave_threads=16</span></tt>—How many threads to use for applying
slave writsets.</li>
</ul>
</div>
<div class="section" id="optional-memory-settings">
<h2>2.5.5. Optional Memory Settings<a class="headerlink" href="#optional-memory-settings" title="Permalink to this headline">¶</a></h2>
<p id="id6">During normal operation a MariaDB Galera node does not consume
much more memory than a regular MariaDB server. Additional
memory is consumed for the certification index and uncommitted
write sets, but usually this is not noticeable in a typical
application. However, writeset caching during state transfer
makes an exception.</p>
<p>When a node is receiving a state transfer, it cannot process
and apply incoming write sets because it has no state to
apply them to yet. Depending on a state transfer mechanism
(for example, <em>mysqldump</em>), the node that sends the state
transfer may not be able to apply write sets. Instead, the
node must cache the write sets for a catch-up phase. Currently,
the write sets are cached in memory and, if the system runs out
of memory, either the state transfer will fail or the cluster
will block and wait for the state transfer to end.</p>
<p>To control memory usage for writeset caching, adjust the
Galera parameters below:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt>—the maximum allowed size of
recv queue. This should normally be half of (RAM + swap).
If this limit is exceeded, Galera will abort the server</li>
<li><tt class="docutils literal"><span class="pre">gcs.recv_q_soft_limit</span></tt>—A fraction of <tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt>
after which replication rate will be throttled.</li>
<li><tt class="docutils literal"><span class="pre">gcs.max_throttle</span></tt>—How much we can throttle the replication
rate during state transfer (to avoid running out of memory).</li>
</ul>
</div>
<div class="section" id="configuration-tips">
<h2>2.5.6. Configuration Tips<a class="headerlink" href="#configuration-tips" title="Permalink to this headline">¶</a></h2>
<p id="id7">This chapter contains some advanced configuration tips.</p>
<div class="section" id="setting-parallel-cpu-threads">
<h3>2.5.6.1. Setting Parallel CPU Threads<a class="headerlink" href="#setting-parallel-cpu-threads" title="Permalink to this headline">¶</a></h3>
<p id="id8">There is no rule about how many slave <abbr title="Central Processing Unit">CPU</abbr>
threads one should configure for replication. At the same time,
parallel threads do not guarantee better performance. However,
parallel applying will not impair regular operation performance
and will most likely speed up the synchronization of new nodes
with the cluster.</p>
<p>Start with four slave threads per core, the logic being that, in a
balanced system, four slave threads can usually saturate the core.
However, depending on IO performance, this figure can be increased
several times (for example, you can use 32 slave threads on a
single-core ThinkPad R51 with a 4200 RPM drive).</p>
<p>The top limit on the total number of slave threads can be
obtained from the <tt class="docutils literal"><span class="pre">wsrep_cert_deps_distance</span></tt> status
variable. This value essentially determines how many writesets
on average can be applied in parallel. Do not use a value higher
than that.</p>
<p>To set four parallel CPU threads, use the parameter value below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wsrep_slave_threads</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Parallel applying requires the following settings:</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">innodb_autoinc_lock_mode=2</span></tt></li>
<li><tt class="docutils literal"><span class="pre">innodb_locks_unsafe_for_binlog=1</span></tt></li>
</ul>
</div>
</div>
<div class="section" id="wan-replication">
<h3>2.5.6.2. WAN Replication<a class="headerlink" href="#wan-replication" title="Permalink to this headline">¶</a></h3>
<p id="id9">Transient network connectivity failures are not rare in
<abbr title="Wide Area Network">WAN</abbr> configurations. Thus, you
may want to increase the keepalive timeouts to avoid
partitioning. The following group of <em>my.cnf</em> settings
tolerates 30 second connectivity outages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wsrep_provider_options</span> <span class="o">=</span> <span class="s">&quot;evs.keepalive_period = PT3S; evs.inactive_check_period = PT10S; evs.suspect_timeout = PT30S; evs.inactive_timeout = PT1M; evs.install_timeout = PT1M&quot;</span>
</pre></div>
</div>
<p>Set the <tt class="docutils literal"><span class="pre">evs.suspect_timeout</span></tt> parameter value as high as possible
to avoid partitions (as partitions will cause state transfers, which
are very heavy). The <tt class="docutils literal"><span class="pre">evs.inactive_timeout</span></tt> parameter value must
be no less than the <tt class="docutils literal"><span class="pre">evs.suspect_timeout</span></tt> parameter value and the
<tt class="docutils literal"><span class="pre">evs.install_timeout</span></tt> parameter value must be no less than the
<tt class="docutils literal"><span class="pre">evs.inactive_timeout</span></tt> parameter value.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">WAN links can have have exceptionally high latencies. Take
Round-Trip Time (RTT) measurements (ping RTT is a fair estimate)
from between your cluster nodes and make sure
that all temporal Galera settings (periods and timeouts, such
as <tt class="docutils literal"><span class="pre">evs.join_retrans_period</span></tt>) exceed the highest RTT in
your cluster.</p>
</div>
</div>
<div class="section" id="multi-master-setup">
<h3>2.5.6.3. Multi-Master Setup<a class="headerlink" href="#multi-master-setup" title="Permalink to this headline">¶</a></h3>
<p id="id10">The more masters (nodes which simultaneously process writes from
clients) are in the cluster, the higher the probability of certification
conflict. This may cause undesirable rollbacks and performance degradation.
In such a case, reduce the number of masters.</p>
</div>
<div class="section" id="single-master-setup">
<h3>2.5.6.4. Single Master Setup<a class="headerlink" href="#single-master-setup" title="Permalink to this headline">¶</a></h3>
<p id="id11">If only one node at a time is used as a master, certain requirements,
such as the slave queue size, may be relaxed. Flow control can be
relaxed by using the settings below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wsrep_provider_options</span> <span class="o">=</span> <span class="s">&quot;gcs.fc_limit = 256; gcs.fc_factor = 0.99; gcs.fc_master_slave = yes&quot;</span>
</pre></div>
</div>
<p>These settings may improve replication performance by
reducing the rate of flow control events. This setting
can also be used as suboptimal in a multi-master setup.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2.5. Configuring Galera Cluster</a><ul>
<li><a class="reference internal" href="#example-configuration-file">2.5.1. Example Configuration File</a></li>
<li><a class="reference internal" href="#mandatory-settings">2.5.2. Mandatory Settings</a></li>
<li><a class="reference internal" href="#optional-mysql-settings">2.5.3. Optional MySQL Settings</a></li>
<li><a class="reference internal" href="#wsrep-provider-settings">2.5.4. wsrep Provider Settings</a></li>
<li><a class="reference internal" href="#optional-memory-settings">2.5.5. Optional Memory Settings</a></li>
<li><a class="reference internal" href="#configuration-tips">2.5.6. Configuration Tips</a><ul>
<li><a class="reference internal" href="#setting-parallel-cpu-threads">2.5.6.1. Setting Parallel CPU Threads</a></li>
<li><a class="reference internal" href="#wan-replication">2.5.6.2. WAN Replication</a></li>
<li><a class="reference internal" href="#multi-master-setup">2.5.6.3. Multi-Master Setup</a></li>
<li><a class="reference internal" href="#single-master-setup">2.5.6.4. Single Master Setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installationxtradb.html"
                        title="previous chapter">2.4. Downloading and Installing Percona XtraDB Cluster</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="createcluster.html"
                        title="next chapter">2.6. Creating a Cluster</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/configuration.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="createcluster.html" title="2.6. Creating a Cluster"
             >next</a> |</li>
        <li class="right" >
          <a href="installationxtradb.html" title="2.4. Downloading and Installing Percona XtraDB Cluster"
             >previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="gettingstarted.html" >2. Getting Started</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Tommi Takkunen-Lauri.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>