

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.6. Node States &mdash; galera 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="galera 1.0.1 documentation" href="index.html" />
    <link rel="up" title="1. Galera Technical Description" href="technicaldescription.html" />
    <link rel="next" title="1.7. Isolation Levels" href="isolationlevels.html" />
    <link rel="prev" title="1.5. State Snapshot Transfer" href="statetransfer.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="isolationlevels.html" title="1.7. Isolation Levels"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="statetransfer.html" title="1.5. State Snapshot Transfer"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" accesskey="U">1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="node-states">
<h1>1.6. Node States<a class="headerlink" href="#node-states" title="Permalink to this headline">¶</a></h1>
<p id="id1">This chapter describes the flow control of node states and the
possible node state changes.</p>
<div class="section" id="flow-control">
<h2>1.6.1. Flow Control<a class="headerlink" href="#flow-control" title="Permalink to this headline">¶</a></h2>
<p id="id2">To ensure temporal synchrony and consistency (as opposed
to logical which is provided by virtual synchrony), Galera
implements several forms of flow control, depending on the
node state.</p>
<div class="section" id="open-and-primary">
<h3>1.6.1.1. <tt class="docutils literal"><span class="pre">OPEN</span></tt> and <tt class="docutils literal"><span class="pre">PRIMARY</span></tt><a class="headerlink" href="#open-and-primary" title="Permalink to this headline">¶</a></h3>
<p>In either of these states, the node is not considered to be
a part of the cluster. It is not allowed to replicate, apply
or cache any write sets. No flow control.</p>
</div>
<div class="section" id="joiner-and-donor">
<h3>1.6.1.2. <tt class="docutils literal"><span class="pre">JOINER</span></tt> and <tt class="docutils literal"><span class="pre">DONOR</span></tt><a class="headerlink" href="#joiner-and-donor" title="Permalink to this headline">¶</a></h3>
<p>In general, the node cannot apply any writesets and it must
cache them. There is no reasonable way to keep the node
synchronized with the cluster (except for stopping all
replication). However, it is possible to limit the replication
rate to make sure that the writeset cache does not exceed the
configured size. The writeset cache cache size is controlled
by the following variables:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt> sets the maximum writeset cache
size (in bytes). The parameter value depends on the amount
of RAM, swap size, and performance considerations. The default
value is <tt class="docutils literal"><span class="pre">SSIZE_MAX</span> <span class="pre">-</span> <span class="pre">2Gb</span></tt> on 32-bit systems. On 64-bit
systems there is practically no limit for the maximum writeset
cache size. If this limit is exceeded and <tt class="docutils literal"><span class="pre">gcs.max_throttle</span></tt>
is not 0.0, the node will abort with an out-of-memory error.
If <tt class="docutils literal"><span class="pre">gcs.max_throttle</span></tt> is 0.0, replication in the cluster
will be stopped.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">gcs.max_throttle</span></tt> is the smallest fraction of the normal
replication rate that we can tolerate in the cluster. 1.0 means
that no replication rate throttling is allowed. 0.0 means that
a complete replication stop is possible. The default value is
0.25.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">gcs.recv_q_soft_limit</span></tt> is a fraction of the <tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt>
and serves to estimate the average replication rate. When it
is exceeded, the average replication rate (in bytes) during
this period is calculated. After that, the replication rate
is decreased linearly with the cache size in a way that at
<tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt> it reaches <tt class="docutils literal"><span class="pre">gcs.max_throttle</span></tt> ×
<tt class="docutils literal"><span class="pre">(average</span> <span class="pre">replication</span> <span class="pre">rate)</span></tt>. The default value is 0.25.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>average replication rate</em> estimated here can
be way off from the sustained one.</p>
</div>
</li>
</ul>
<p>To sum up, the writeset cache grows semi-logarithmically with time
after the <tt class="docutils literal"><span class="pre">gcs.recv_q_soft_limit</span></tt> and the time needed for the
state transfer to complete.</p>
</div>
<div class="section" id="joined">
<h3>1.6.1.3. <tt class="docutils literal"><span class="pre">JOINED</span></tt><a class="headerlink" href="#joined" title="Permalink to this headline">¶</a></h3>
<p>A <tt class="docutils literal"><span class="pre">JOINED</span></tt> node can apply writesets. In this state, flow control
makes sure that the node can eventually catch-up with the cluster,
specifically that its writeset cache never grows. Thus, the
cluster-wide replication rate is limited by the rate at which
the node can apply the writesets. Since applying a writeset is
usually several times faster than processing a transaction,
it hardly ever affects the performance of the cluster, except
at the very beginning, when the buffer pool on the node is empty.
Using <em>parallel applying</em> can significantly speed it up.</p>
</div>
<div class="section" id="synced">
<h3>1.6.1.4. <tt class="docutils literal"><span class="pre">SYNCED</span></tt><a class="headerlink" href="#synced" title="Permalink to this headline">¶</a></h3>
<p>In the <tt class="docutils literal"><span class="pre">SYNCED</span></tt> state, the node flow control attempts to keep
the slave queue to a minimum. This is controlled by the following
configuration variables:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">gcs.fc_limit</span></tt>—When the slave queue exceeds this limit,
replication is paused. It is essential for multi-master
configurations that this limit is low, as the certification
conflict rate is proportional to the slave queue length.
In master-slave setups, this value can be considerably higher
to reduce flow control intervention. The default value is 16.</li>
<li><tt class="docutils literal"><span class="pre">gcs.fc_factor</span></tt>—When the slave queue goes below
<tt class="docutils literal"><span class="pre">gcs.fc_limit</span></tt> × <tt class="docutils literal"><span class="pre">gcs.fc_factor</span></tt>, replication
is resumed. The default value is 0.5.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While it is critical for multi-master operation to have
as small slave queue as possible, the slave queue length
is not so critical for master-slave setups, since,
depending on the application and hardware, even 1K of
writesets may be applied in a fraction of a second.
The slave queue length has no effect on master-slave
failover.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Since Galera nodes process transactions asynchronously
with regards to each other, the amount of replication
data cannot be anticipated in any way. Hence, Galera
flow control is reactive, that is, it only affects after
certain limits are exceeded. It cannot prevent exceeding
these limits or make any guarantees about by how much
these limits will be exceeded. For example, if
<tt class="docutils literal"><span class="pre">gcs.recv_q_hard_limit</span></tt> is set to <tt class="docutils literal"><span class="pre">100Mb</span></tt>, it can
still be exceeded by a 1Gb writeset.</p>
</div>
</div>
</div>
<div class="section" id="node-state-changes">
<h2>1.6.2. Node State Changes<a class="headerlink" href="#node-state-changes" title="Permalink to this headline">¶</a></h2>
<p id="id3">Galera node state machines handle different state changes on
different Galera layers. At the top layer, there are node
state changes as depicted in the figure below:</p>
<div class="figure">
<img alt="_images/galerafsm.png" src="_images/galerafsm.png" />
<p class="caption"><em>Galera Node State Changes</em></p>
</div>
<p>In the figure:</p>
<ol class="arabic simple">
<li>The node establishes a connection to a <em>primary component</em>.</li>
<li>The state <em>transfer request</em> of the node succeeds. The node
starts to cache the write sets.</li>
<li>The node receives a state snapshot. Now it has all cluster
data and can start applying the cached writesets. Flow control
is switched on to ensure eventual slave queue decrease.</li>
<li>The node completes catching up with the cluster (the slave
queue is empty). Flow control is switched on to keep the
slave queue empty. The MySQL <tt class="docutils literal"><span class="pre">wsrep_ready</span> <span class="pre">status</span></tt> variable
is set to 1 and the node is allowed to process transactions.</li>
<li>The node receives a state transfer request. Flow control is
relaxed to <tt class="docutils literal"><span class="pre">JOINER</span></tt>. The node caches the write sets it
cannot apply.</li>
<li>The node completes the state transfer to <tt class="docutils literal"><span class="pre">JOINER</span></tt>.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To keep the graph easier to read, the following
transitions were omitted from it:</p>
<ul class="last simple">
<li>At any time, cluster configuration change event
can send the node to <tt class="docutils literal"><span class="pre">PRIMARY</span></tt> or <tt class="docutils literal"><span class="pre">OPEN</span></tt>
state, for example <tt class="docutils literal"><span class="pre">SYNCED</span></tt>→<tt class="docutils literal"><span class="pre">OPEN</span></tt>,
when a node loses connection to primary component
due to network partition.</li>
<li>If the node does not need a state transfer (for
example, a node restart in an idle cluster) it
goes straight from the <tt class="docutils literal"><span class="pre">PRIMARY</span></tt> state to the
<tt class="docutils literal"><span class="pre">JOINED</span></tt> state.</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1.6. Node States</a><ul>
<li><a class="reference internal" href="#flow-control">1.6.1. Flow Control</a><ul>
<li><a class="reference internal" href="#open-and-primary">1.6.1.1. <tt class="docutils literal"><span class="pre">OPEN</span></tt> and <tt class="docutils literal"><span class="pre">PRIMARY</span></tt></a></li>
<li><a class="reference internal" href="#joiner-and-donor">1.6.1.2. <tt class="docutils literal"><span class="pre">JOINER</span></tt> and <tt class="docutils literal"><span class="pre">DONOR</span></tt></a></li>
<li><a class="reference internal" href="#joined">1.6.1.3. <tt class="docutils literal"><span class="pre">JOINED</span></tt></a></li>
<li><a class="reference internal" href="#synced">1.6.1.4. <tt class="docutils literal"><span class="pre">SYNCED</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#node-state-changes">1.6.2. Node State Changes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="statetransfer.html"
                        title="previous chapter">1.5. State Snapshot Transfer</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="isolationlevels.html"
                        title="next chapter">1.7. Isolation Levels</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/nodestates.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="isolationlevels.html" title="1.7. Isolation Levels"
             >next</a> |</li>
        <li class="right" >
          <a href="statetransfer.html" title="1.5. State Snapshot Transfer"
             >previous</a> |</li>
        <li><a href="index.html">galera 1.0.1 documentation</a> &raquo;</li>
          <li><a href="technicaldescription.html" >1. Galera Technical Description</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Tommi Takkunen-Lauri.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>